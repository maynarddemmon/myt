<!doctype html><html><head>
<title>Myt Framework : WebSocket Example</title>
<link rel="stylesheet" href="../src/css/myt.css"/>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="../src/js/jquery/jquery-1.12.4.min.js">\x3C/script>');</script>

<script>var ROOT = '../src/js/';</script>
<script src="../src/js/boilerplate.js"></script>
<script src="../src/js/jsclass/min/loader-browser.js"></script>
<script src="../src/js/myt/manifest.js"></script>

</head><body>
<script>
    // This example works with wsrelay.
    JS.require('myt.all', function() {
        var rootView = new myt.View(null, {bgColor:'#000000', textColor:'#00cc00'}, [myt.SizeToWindow]);
        var btnsView = new myt.View(rootView, {percentOfParentWidth:100, height:28, bgColor:'#333333'}, [myt.SizeToParent]);
        var connectBtn = new myt.SimpleButton(btnsView, {y:4, height:20, text:'connect', shrinkToFit:true, inset:6, outset:6,
            activeColor:'#222222', hoverColor:'#555555', readyColor:'#444444', roundedCorners:2
        }, [myt.TextButtonContent, {
            doActivated:function() {
                if (ws.status === 'closed') {
                    ws.connect();
                } else {
                    ws.close();
                }
            }
        }]);
        var msgView = new myt.InputText(btnsView, {y:4, height:20, bgColor:'#000000',
            roundedCorners:4, border:[1,'solid','#006600'], textColor:'#00cc00', layoutHint:1
        }, [{
            initNode: function(parent, attrs) {
                this.callSuper(parent, attrs);
                
                this.attachToDom(this, 'handleKeyDown', 'keydown');
            },
            handleKeyDown: function(event) {
                if (myt.KeyObservable.getKeyCodeFromEvent(event) === 13) sendBtn.doActivated();
            }
        }]);
        var sendBtn = new myt.SimpleButton(btnsView, {y:4, height:20, text:'send', shrinkToFit:true, inset:6, outset:6,
            activeColor:'#222222', hoverColor:'#555555', readyColor:'#444444', roundedCorners:2
        }, [myt.TextButtonContent, {
            doActivated:function() {
                var msg = msgView.value;
                logView.setText(logView.text + '<font color="#999900">&gt; ' + msg + '</font><br/>');
                try {
                    msg = JSON.parse(msg);
                } catch (ex) {
                    try {
                        msg = JSON.parse('"' + msg + '"');
                    } catch (ex) {
                        console.error(ex);
                    }
                }
                ws.sendTypedMessage('message', msg);
            }
        }]);
        var sendActionBtn = new myt.SimpleButton(btnsView, {y:4, height:20, text:'action', shrinkToFit:true, inset:6, outset:6,
            activeColor:'#222222', hoverColor:'#555555', readyColor:'#444444', roundedCorners:2
        }, [myt.TextButtonContent, {
            doActivated:function() {
                var msg = msgView.value;
                logView.setText(logView.text + '<font color="#999900">* ' + msg + ' *</font><br/>');
                try {
                    msg = JSON.parse(msg);
                } catch (ex) {
                    try {
                        msg = JSON.parse('"' + msg + '"');
                    } catch (ex) {
                        console.error(ex);
                    }
                }
                ws.sendTypedMessage('message.action', msg);
            }
        }]);
        var clearBtn = new myt.SimpleButton(btnsView, {y:4, height:20, text:'clear text', shrinkToFit:true, inset:6, outset:6,
            activeColor:'#222222', hoverColor:'#555555', readyColor:'#444444', roundedCorners:2
        }, [myt.TextButtonContent, {
            doActivated:function() {
                logView.setText('');
            }
        }]);
        new myt.ResizeLayout(btnsView, {inset:4, spacing:4, outset:4});
        
        var logView = new myt.Text(rootView, {
            x:10, y:30, percentOfParentWidth:100, percentOfParentWidthOffset:-20, text:'', fontSize:'12px', fontFamily:'monospace'
        }, [myt.SizeToParent]);
        
        var ws = new myt.MessageTypeWebSocket(rootView, {url:'ws://localhost:8124'}, [{
            setStatus:function(v) {
                this.callSuper(v);
                switch (this.status) {
                    case 'open':
                        connectBtn.setText('disconnect');
                        break;
                    case 'closed':
                        connectBtn.setText('connect');
                    default:
                }
            },
            onOpen: function(event) {
                this.callSuper(event);
                logView.setText(logView.text + '<b>OPENED</b><br/>');
            },
            onError: function(event) {
                this.callSuper(event);
                logView.setText(logView.text + '<b>ERROR</b><br/>' + event + '<br/>');
            },
            onClose: function(event) {
                this.callSuper(event);
                logView.setText(logView.text + '<b>CLOSED</b><br/>');
            }
        }]);
        
        var consoleLoggerFunc = function(msg) {console.log(msg);};
        var messageMatcher = function(type) {return type === 'message' || type.startsWith('message.');};
        var actionMatcher = function(type) {return type.startsWith('message.') && type.endsWith('.action');};
        var processMessageFunc = function(msg) {
            msg = msg.msg;
            if (typeof msg !== 'string') {
                logView.setText(logView.text + '<font color="#0099ff">< ' + msg + '</font><br/>');
            } else {
                logView.setText(logView.text + '< ' + msg + '<br/>');
            }
        };
        var processActionFunc = function(msg) {
            msg = msg.msg;
            if (typeof msg !== 'string') {
                logView.setText(logView.text + '<font color="#0099ff">* ' + msg + ' *</font><br/>');
            } else {
                logView.setText(logView.text + '* ' + msg + ' *<br/>');
            }
        };
        
        ws.registerListener(consoleLoggerFunc, 'message');
        ws.unregisterListener(consoleLoggerFunc, 'message');
        ws.registerListener(consoleLoggerFunc, messageMatcher);
        
        ws.registerListener(processMessageFunc, 'message');
        ws.registerListener(processActionFunc, actionMatcher);
    });
</script>
</body></html>
